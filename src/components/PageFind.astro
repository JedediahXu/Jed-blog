---
// Inspired by -> https://github.com/chrismwilliams/astro-theme-cactus/blob/main/src/components/Search.astro

import '@pagefind/default-ui/css/ui.css'
---

<site-search id="search" class="ms-auto">
  <button
    data-open-modal
    aria-label="点击搜索"
    class="data-open dark:hover:bg-lightGray hover:bg-crystalClear flex items-center justify-center rounded-md gap-1"
  >
    <span class="md:hidden text-xl"> <i class="iconfont icon-search"></i></span></button
  >
  <dialog
    aria-label="search"
    class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-white dark:bg-[#232323] shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md opacity-0"
  >
    <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
      <button
        data-close-modal
        aria-label="关闭"
        class="ms-auto cursor-pointer rounded-full bg-black text-white px-4 py-2 dark:bg-white dark:text-black"
        >Close</button
      >
      {
        import.meta.env.DEV ? (
          <div class="mx-auto text-center dark:text-white">
            <p>
              Search is only available in production builds. <br />
              Try building and previewing the site to test it out locally.
            </p>
          </div>
        ) : (
          <div class="search-container dark:text-white">
            <div id="pagefind__search" />
          </div>
        )
      }
    </div>
  </dialog>
</site-search>

<script>
  // @ts-ignore
  import { animate } from 'motion'
  class SiteSearch extends HTMLElement {
    constructor() {
      super()
      const openBtn = this.querySelector<HTMLButtonElement>('button[data-open-modal]')!
      const closeBtn = this.querySelector<HTMLButtonElement>('button[data-close-modal]')!
      const dialog = this.querySelector('dialog')!
      const dialogFrame = this.querySelector('.dialog-frame')!

      const onWindowClick = (event: MouseEvent) => {
        // make sure the click is outside the of the dialog
        if (
          document.body.contains(event.target as Node) &&
          !dialogFrame.contains(event.target as Node)
        )
          closeModal()
      }

      const openModal = (event?: MouseEvent) => {
        dialog.showModal()

        animate(
          'dialog',
          {
            clipPath: [
              'polygon(0 0, 100% 0, 100% -200%, -200% -200%)',
              'polygon(0 0, 100% 0, 100% 100%, 0% 100%)',
            ],
            opacity: [0, 1],
          },
          { duration: 0.2 }
        )
        document.body.classList.add('overflow-hidden')
        this.querySelector('input')?.focus()
        event?.stopPropagation()
        window.addEventListener('click', onWindowClick)
      }

      const closeModal = () => {
        dialog.close()
        document.body.classList.remove('overflow-hidden')
        window.removeEventListener('click', onWindowClick)
      }

      openBtn.addEventListener('click', openModal)
      openBtn.disabled = false
      closeBtn.addEventListener('click', closeModal)
      document.addEventListener('astro:after-swap', closeModal)

      // Listen for `/` keyboard shortcut
      window.addEventListener('keydown', (e) => {
        if (e.key === '/' && !dialog.open) {
          openModal()
          e.preventDefault()
        }
      })

      document.addEventListener(
        'astro:page-load',
        () => {
          if (import.meta.env.DEV) return
          const onIdle = window.requestIdleCallback || ((cb) => setTimeout(cb, 1))
          onIdle(async () => {
            // @ts-ignore
            const { PagefindUI } = await import('@pagefind/default-ui')
            new PagefindUI({
              element: '#pagefind__search',
              baseUrl: import.meta.env.BASE_URL,
              bundlePath: import.meta.env.BASE_URL.replace(/\/$/, '') + '/pagefind/',
              showImages: true,
              excerptLength: 10,
              debounceTimeoutMs: 500,
              showEmptyFilters: true,
            })
          })
        },
        { once: true }
      )
    }
  }

  customElements.define('site-search', SiteSearch)
</script>

<style is:global lang="scss">
  .dark {
    --pagefind-ui-primary: #eeeeee;
    --pagefind-ui-text: #eeeeee;
    --pagefind-ui-background: rgba(68, 68, 68, 0.6);
    --pagefind-ui-border: rgba(68, 68, 68, 0.6);
    --pagefind-ui-tag: rgba(68, 68, 68, 0.6);
  }
  .pagefind-ui__result-image {
    height: 100% !important;
  }
  .pagefind-ui__search-clear.svelte-e9gkc3 {
    border-radius: 5px !important;
    padding-left: 10px !important;
  }
  .data-open {
    width: 40px;
    height: 40px;
    display: flex;
    justify-content: center;
    align-items: center;

    span i {
      font-size: 18px;
    }
  }
</style>
